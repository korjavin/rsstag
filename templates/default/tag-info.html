<html>
<head>
<script type="text/javascript" src="https://www.chartjs.org/dist/2.9.4/Chart.min.js"></script>
<link rel="stylesheet" href="/static/vis-dist/vis.min.css" />
<title>Page of tag {{tag['tag']}}</title>
{%  include "head-data.html" %}
</head>
<body>
{% import 'main-menu.html' as menu with context %}{% import 'global-status.html' as g_status with context %}
<div id="global_tools">
    <div class="left_half">
        <div id="link_on_root" class="global_tools_button">
            <a href="/">main</a>
        </div>
        <div id="help_button" class="global_tools_button">
            <a href="#">help</a>
        </div>
        <div id="sotr_by" class="global_tools_button">
            <a href="{{sort_by_link}}">group by tag</a>
        </div>
        <div id="group_by" class="global_tools_button">
            <a href="{{group_by_link}}">group by category</a>
        </div>
    </div>
    <div class="right_half">
        {{ g_status.global_status() }}
        {{ menu.settings_menu() }}
    </div>
</div>
<div class="page">
    <div class="group_title">
        <h3><a href="{{tag['local_url']}}">{{tag['tag']}}</a> ({{tag['unread_count']}} / {{tag['posts_count']}})&nbsp;</h3>
        {{','.join(tag['words'])}} <a href="/tag-net#{{tag['tag']}}">Tag net</a>
    </div>
    <h3 class="group_title tag_info_title">Similar tags by Doc2Vec</h3><span id="load_similar_d2v"></span>
    <div id="similar_d2v_tags" class="tag_info_block"></div>
    <h3 class="group_title tag_info_title">Similar tags by Word2Vec</h3><span id="load_similar_w2v"></span>
    <div id="similar_w2v_tags" class="tag_info_block"></div>
    <h3 class="group_title tag_info_title">Siblings tags</h3><span id="load_siblings"></span>
    <div id="siblings_tags" class="tag_info_block"></div>
    <h3 class="group_title tag_info_title">Bi-grams</h3><span id="load_bi_grams"></span>
    <div id="bi_grams" class="tag_info_block"></div>
    <h3 class="group_title tag_info_title">Mentions chart</h3>
    <div id="mentions_chart" class="tag_info_block">
        <canvas id="mentions_chart_canvas"></canvas>
    </div>
</div>
<div id="global_tools_bottom">
    <ul id="paginator"></ul>
</div>
<!--script language="javascript" type="application/javascript">
    var count = document.getElementById('cloud_items_count');
    count.innerHTML = document.getElementsByTagName('li').length;
</script-->
<script type="text/javascript">
    const initial_tag = {{tag|json}};
</script>
<div id="help_window">
<ul>
    <li>Click/tap on one tag and then click/tap on other tag, will open the page with posts have selected tags</li>
</ul>
</div>
<div id="progressbar"></div></body>
<script type="text/javascript">
(() => {
function fetchJSON(url, opts) {
        let req_promise = fetch(url, opts),
            prom = new Promise((resolve, reject) => {
                req_promise.then(response => {
                    response.json().then(data => {
                        resolve(data);
                    }).catch(err => {
                        reject(err);
                    });
                }).catch(err => {
                    reject(err);
                });
            })

        return prom;
    }
        //let ru = new RssTagUtils();
    let prom = fetchJSON("/tags-dates/" + encodeURIComponent(initial_tag.tag));
    prom.then((data) => {
        let block = document.querySelector("#mentions_chart");
        if (block) {
            let mp = {};
            let current = 0;
            let aggr = 3600 * 24 * 1000;
            let k = "";
            data.data.sort();
            for (let u of data.data) {
                u *= 1000;
                let d = new Date();
                if ((current === 0) || ((current + aggr) < u)) {
                    d.setTime(u);
                    d.setMinutes(0);
                    d.setMilliseconds(0);
                    d.setSeconds(0);
                    current = d.getTime();
                    k = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                }
                if (!(k in mp)) {
                    mp[k] = 0
                }
                mp[k]++;
            }
            let labels = [];
            let values = [];
            for (let k in mp) {
                labels.push(k);
                values.push(mp[k]);
            }
            //block.textContent = JSON.stringify(mp);
            let dtset = {
                labels: labels,
                datasets: [{
                    label: initial_tag.tag,
                    data: values
                }]
            }
            let ch = new Chart(block.querySelector("#mentions_chart_canvas").getContext("2d"), {
                type: "bar",
                data: dtset
            });
        }
    });
})();
</script>
</html>